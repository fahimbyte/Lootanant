<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üßà Lootanant ‚Äî Gold Bar Auction!</title>
<style>
/* ‚îÄ‚îÄ Spectate List ‚îÄ‚îÄ */
#spectateList {
  background: #16213e;
  border-radius: 16px;
  padding: 20px;
  width: 100%;
  max-width: 420px;
  margin-top: 20px;
}
.room-item {
  background: #0f3460;
  padding: 12px;
  border-radius: 10px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: transform 0.2s;
}
.room-item:hover {
  transform: scale(1.02);
  cursor: pointer;
}
.room-item .room-info {
  display: flex;
  flex-direction: column;
}
.room-item .room-info b {
  color: #e94560;
}

/* ‚îÄ‚îÄ Reset & Base ‚îÄ‚îÄ */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',system-ui,sans-serif;background:#1a1a2e;color:#e0e0e0;min-height:100vh;display:flex;flex-direction:column;align-items:center;overflow-x:hidden}
h1,h2,h3{font-weight:700}
button{cursor:pointer;border:none;border-radius:8px;padding:10px 22px;font-size:1rem;font-weight:600;transition:all .15s}
button:hover{filter:brightness(1.15)}
input{border:2px solid #444;border-radius:8px;padding:10px 14px;font-size:1rem;background:#16213e;color:#e0e0e0;outline:none}
input:focus{border-color:#e94560}

/* ‚îÄ‚îÄ Screens ‚îÄ‚îÄ */
.screen{display:none;width:100%;max-width:960px;padding:20px}
.screen.active{display:flex;flex-direction:column;align-items:center}

/* ‚îÄ‚îÄ Lobby ‚îÄ‚îÄ */
#lobby{margin-top:10vh}
#lobby h1{font-size:2.4rem;color:#e94560;margin-bottom:4px}
#lobby .subtitle{color:#888;margin-bottom:30px;font-size:1.05rem}
.lobby-box{background:#16213e;border-radius:16px;padding:30px;width:100%;max-width:420px;display:flex;flex-direction:column;gap:14px;box-shadow:0 8px 30px rgba(0,0,0,.4)}
.lobby-box label{font-size:.85rem;color:#aaa;margin-bottom:-8px}
.btn-primary{background:#e94560;color:#fff}
.btn-secondary{background:#0f3460;color:#fff}
.btn-small{padding:8px 16px;font-size:.85rem}
.or-divider{text-align:center;color:#555;font-size:.9rem;margin:4px 0}

/* ‚îÄ‚îÄ Waiting Room ‚îÄ‚îÄ */
#waitingRoom{margin-top:6vh}
.room-code-display{font-size:2rem;letter-spacing:6px;color:#e94560;background:#16213e;padding:12px 28px;border-radius:12px;margin:10px 0 20px}
.player-list-wait{list-style:none;display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:16px 0}
.player-list-wait li{background:#0f3460;padding:8px 18px;border-radius:20px;font-size:.95rem;display:flex;align-items:center;gap:8px}
.player-list-wait li.cpu{opacity:.7;font-style:italic}
.player-list-wait li input{padding:4px 8px;font-size:.85rem;width:110px;background:#1a1a2e;border:1px solid #e94560;border-radius:6px;color:#e0e0e0}
.host-controls{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;justify-content:center}

/* Game Settings */
.game-settings{background:#16213e;border-radius:14px;padding:18px 22px;width:100%;max-width:420px;margin-top:14px;display:flex;flex-direction:column;gap:12px}
.game-settings h3{color:#e94560;font-size:1rem;margin:0;text-align:center}
.setting-row{display:flex;align-items:center;justify-content:space-between;gap:10px}
.setting-row label{font-size:.85rem;color:#ccc;white-space:nowrap}
.setting-row input[type=number]{width:80px;padding:6px 10px;font-size:.95rem;text-align:center;background:#1a1a2e;border:2px solid #444;border-radius:8px;color:#e0e0e0}
.setting-row input[type=number]:focus{border-color:#e94560}
.setting-hint{font-size:.7rem;color:#666;text-align:center;margin-top:-4px}

/* ‚îÄ‚îÄ Game Board ‚îÄ‚îÄ */
#gameBoard{margin-top:2vh}
.board-top{display:flex;justify-content:space-between;align-items:center;width:100%;margin-bottom:8px;flex-wrap:wrap;gap:8px}
.room-badge{background:#0f3460;padding:6px 14px;border-radius:8px;font-size:.8rem}

/* Deed Card */
.deed-area{display:flex;flex-direction:column;align-items:center;margin:10px 0 14px}
.deed-card{width:130px;height:185px;background:linear-gradient(135deg,#ffd700,#b8860b);border:3px solid #daa520;border-radius:16px;display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 6px 25px rgba(218,165,32,.6), inset 0 0 20px rgba(255,255,255,0.4);position:relative;transition:transform .3s;overflow:hidden}
.deed-card::after{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(45deg, transparent 45%, rgba(255,255,255,0.3) 50%, transparent 55%);transform:rotate(-45deg);animation:shine 3s infinite;pointer-events:none}
@keyframes shine{0%{transform:translateX(-100%) rotate(-45deg)}100%{transform:translateX(100%) rotate(-45deg)}}
.deed-card .value{font-size:3rem;font-weight:800;color:#333;text-shadow:1px 1px 2px rgba(255,255,255,0.5)}
.deed-subtitle{margin-top:6px;font-size:.8rem;color:#888}

/* Animations */
@keyframes gavel{0%{transform:scale(1)}50%{transform:scale(1.15) rotate(-5deg)}100%{transform:scale(1)}}
.deed-card.gavel{animation:gavel .5s ease}

@keyframes flipIn{0%{transform:rotateY(90deg) scale(.8);opacity:0}100%{transform:rotateY(0) scale(1);opacity:1}}
.deed-card.flip-in{animation:flipIn .5s ease}

@keyframes bidWin{0%{box-shadow:0 0 0 0 rgba(255,215,0,.7)}50%{box-shadow:0 0 40px 15px rgba(255,215,0,.5)}100%{box-shadow:0 0 0 0 rgba(255,215,0,0)}}
.bid-win-glow{animation:bidWin 1s ease}

@keyframes netWorthPop{0%{transform:scale(1);color:#e0e0e0}40%{transform:scale(1.5);color:gold}100%{transform:scale(1);color:#e0e0e0}}
.nw-pop{animation:netWorthPop .7s ease}

@keyframes turnPulse{0%{border-color:#e94560;box-shadow:0 0 8px rgba(233,69,96,.4)}50%{border-color:#ff6b81;box-shadow:0 0 20px rgba(233,69,96,.7)}100%{border-color:#e94560;box-shadow:0 0 8px rgba(233,69,96,.4)}}
.active-turn{animation:turnPulse 1.5s ease infinite}

@keyframes slideDown{0%{transform:translateY(-30px);opacity:0}100%{transform:translateY(0);opacity:1}}
.slide-down{animation:slideDown .4s ease}

@keyframes fadeScale{0%{transform:scale(.8);opacity:0}100%{transform:scale(1);opacity:1}}
.fade-scale{animation:fadeScale .4s ease}

/* High Bid Display ‚Äî compact strip below roundtable */
.high-bid-bar{background:#16213e;border-radius:10px;padding:8px 16px;display:flex;justify-content:center;align-items:center;width:100%;max-width:500px;margin:0 auto 10px;gap:8px;flex-wrap:wrap}
.high-bid-bar .amount{color:#e94560;font-size:1.1rem;font-weight:700}

/* Roundtable */
.roundtable{position:relative;width:100%;max-width:600px;min-height:400px;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;padding:40px 0}
.roundtable-center{width:160px;height:160px;border-radius:50%;background:radial-gradient(circle,#1e2a4a,#16213e);border:3px solid #0f3460;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:2;box-shadow:0 0 30px rgba(15,52,96,.5)}
.roundtable-center .deed-card{width:80px;height:110px;border-radius:10px}
.roundtable-center .deed-card .value{font-size:1.8rem}

/* Player seats around table */
.player-seat{position:absolute;text-align:center;transition:all .3s}
.player-card{background:#16213e;border-radius:14px;padding:12px 14px;min-width:110px;text-align:center;position:relative;border:2px solid transparent;transition:all .3s}
.player-card.passed{opacity:.45}
.player-card.winner-card{border-color:gold!important;box-shadow:0 0 20px rgba(255,215,0,.6)!important}
.player-card .avatar{font-size:1.6rem;margin-bottom:2px}
.player-card .pname{font-weight:600;font-size:.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100px}
.player-card .stat{font-size:.75rem;color:#aaa;margin-top:2px}
.player-card .stat b{color:#e0e0e0}
.player-card .you-badge{position:absolute;top:-8px;right:-8px;background:#e94560;color:#fff;font-size:.6rem;padding:2px 6px;border-radius:10px}
.player-card .bid-badge{position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);background:#0f3460;color:#e94560;font-size:.6rem;padding:2px 8px;border-radius:8px;white-space:nowrap}

/* Ranking Area ‚Äî compact horizontal strip above roundtable */
.ranking-area{background:#16213e;border-radius:10px;padding:8px 14px;width:100%;max-width:600px;margin-bottom:10px;display:flex;align-items:center;gap:6px;justify-content:center;flex-wrap:wrap}
.ranking-area h4{color:#e94560;font-size:.75rem;margin:0 6px 0 0;white-space:nowrap}
.ranking-row{display:flex;align-items:center;gap:4px;padding:2px 8px;font-size:.78rem;background:#0f3460;border-radius:8px}
.ranking-row .rank-medal{font-size:.9rem;width:auto}
.ranking-row .rank-name{font-weight:600;white-space:nowrap}
.ranking-row .rank-nw{color:#e94560;font-weight:700}

/* Bid Console */
.bid-console{background:#16213e;border-radius:14px;padding:14px 20px;width:100%;max-width:500px;display:flex;flex-direction:column;align-items:center;gap:10px}
.bid-console .prompt{font-size:1rem;color:#ccc}
.bid-buttons{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
.bid-buttons button{min-width:52px;padding:10px 14px;font-size:1rem;background:#0f3460;color:#fff;border-radius:10px}
.bid-buttons button:hover{background:#e94560}
.btn-pass{background:#333!important;color:#e94560!important;font-size:1.1rem;padding:12px 30px}
.timer-bar{width:100%;height:6px;background:#333;border-radius:3px;overflow:hidden;margin-top:4px}
.timer-bar .fill{height:100%;background:#e94560;transition:width .5s linear}

/* Winner Overlay */
#winnerOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:100;flex-direction:column;align-items:center;justify-content:center;text-align:center}
#winnerOverlay.active{display:flex}
#winnerOverlay .trophy{font-size:5rem;margin-bottom:10px;animation:trophyBounce 1s ease infinite alternate}
@keyframes trophyBounce{0%{transform:scale(1) rotate(-5deg)}100%{transform:scale(1.1) rotate(5deg)}}
#winnerOverlay h2{font-size:2.2rem;color:gold;margin-bottom:6px}
#winnerOverlay p{color:#ccc;font-size:1.1rem;margin-bottom:20px}

/* Round Banner */
.round-banner{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);background:rgba(15,52,96,.95);border:3px solid #e94560;border-radius:20px;padding:30px 50px;z-index:80;text-align:center;transition:transform .3s ease,opacity .3s ease;opacity:0;pointer-events:none}
.round-banner.show{transform:translate(-50%,-50%) scale(1);opacity:1}
.round-banner h2{color:#e94560;font-size:1.8rem;margin-bottom:6px}
.round-banner p{color:#ccc;font-size:1rem}
.round-banner .round-number{font-size:.85rem;color:#ffd700;margin-top:6px}

/* Turn Banner */
.turn-banner{position:fixed;top:12%;left:50%;transform:translateX(-50%) translateY(-20px);background:rgba(233,69,96,.9);color:#fff;padding:10px 30px;border-radius:12px;font-size:1.1rem;font-weight:700;z-index:70;opacity:0;transition:all .3s ease;pointer-events:none}
.turn-banner.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* Manual */
#manual{margin-top:4vh;padding-bottom:40px}
.manual-box{background:#16213e;border-radius:16px;padding:30px;max-width:700px;width:100%;line-height:1.7}
.manual-box h2{color:#e94560;margin-bottom:14px;font-size:1.6rem}
.manual-box h3{color:#e94560;margin:18px 0 6px;font-size:1.15rem}
.manual-box ul{margin-left:20px}
.manual-box li{margin-bottom:4px}
.manual-box .icon{font-size:1.2rem;margin-right:4px}
.back-link{margin-top:18px;color:#e94560;cursor:pointer;font-size:.95rem}
.back-link:hover{text-decoration:underline}

/* Toast */
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#0f3460;color:#fff;padding:14px 28px;border-radius:12px;font-size:1rem;z-index:90;opacity:0;transition:opacity .3s;pointer-events:none;max-width:90vw;text-align:center}
.toast.show{opacity:1}

/* ‚îÄ‚îÄ Rage Mode: King's Vault ‚îÄ‚îÄ */
.kings-vault{background:linear-gradient(135deg,#ffd700,#b8860b);border-radius:14px;padding:10px 18px;display:flex;align-items:center;gap:10px;margin:0 auto 10px;max-width:500px;box-shadow:0 0 15px rgba(255,215,0,.3);transition:all .3s}
.kings-vault.glow{box-shadow:0 0 30px rgba(255,215,0,.7);transform:scale(1.05)}
.kings-vault.shake{animation:vaultShake .5s ease}
@keyframes vaultShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}
.kings-vault .vault-icon{font-size:1.8rem}
.kings-vault .vault-amount{font-size:1.2rem;font-weight:800;color:#333}
.kings-vault .vault-label{font-size:.7rem;color:#5a3e00;font-weight:600}

/* Rage Mode: Bribe & Loan Panel */
.rage-panel{background:#16213e;border-radius:14px;padding:12px 18px;width:100%;max-width:500px;margin:0 auto 10px;display:flex;flex-wrap:wrap;gap:8px;justify-content:center;align-items:center}
.rage-panel .rage-title{width:100%;text-align:center;font-size:.8rem;color:#e94560;font-weight:700;margin-bottom:2px}
.btn-bribe{background:#8b0000;color:#fff;font-size:.8rem;padding:6px 12px;border-radius:8px}
.btn-bribe:hover{background:#c0392b}
.bribe-amount-step{display:flex;flex-direction:column;gap:8px;margin:12px 0}
.bribe-amount-step label{color:#ccc;font-size:.85rem}
.bribe-amount-btns{display:flex;gap:6px;justify-content:center}
.bribe-amount-btns button{background:#8b0000;color:#fff;padding:8px 16px;border-radius:8px;font-size:.9rem;cursor:pointer;border:none}
.bribe-amount-btns button:hover{background:#c0392b}
.bribe-amount-btns button:disabled{opacity:.3;cursor:not-allowed}
.btn-loan{background:#2e7d32;color:#fff;font-size:.8rem;padding:6px 12px;border-radius:8px}
.btn-loan:hover{background:#43a047}
.bribe-indicator{color:#e94560;font-size:.6rem;position:absolute;top:-6px;left:-6px}
.tax-countdown{font-size:.75rem;color:#ffd700;text-align:center;margin:4px 0}

/* Rage Mode: Jackpot Round */
.jackpot-badge{background:linear-gradient(135deg,#ffd700,#ff6b00);color:#333;font-weight:800;font-size:.85rem;padding:6px 14px;border-radius:10px;text-align:center;animation:jackpotPulse 1.5s ease infinite;margin:4px auto}
@keyframes jackpotPulse{0%,100%{box-shadow:0 0 8px rgba(255,215,0,.5);transform:scale(1)}50%{box-shadow:0 0 25px rgba(255,215,0,.9);transform:scale(1.05)}}
.deed-card.jackpot-card{border-color:#ff6b00!important;box-shadow:0 6px 25px rgba(255,107,0,.6), inset 0 0 20px rgba(255,255,255,0.4)!important}

/* Rage Mode: Tax Overlay */
.tax-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:85;flex-direction:column;align-items:center;justify-content:center;text-align:center}
.tax-overlay.active{display:flex}
.tax-overlay .auditor{font-size:4rem;animation:auditorWalk 3s ease-in-out}
@keyframes auditorWalk{0%{transform:translateX(-100vw)}50%{transform:translateX(0) scale(1.2)}100%{transform:translateX(0) scale(1)}}
.tax-overlay h2{color:#ffd700;font-size:1.6rem;margin:10px 0}
.tax-overlay .tax-detail{color:#ccc;font-size:.9rem;margin:2px 0}
.tax-confirm-btn{margin-top:16px;background:#e94560;color:#fff;padding:12px 30px;border-radius:10px;font-size:1rem;font-weight:700;cursor:pointer;border:none;animation:pulse 1.5s ease infinite}
.tax-confirm-btn:disabled{opacity:.4;cursor:not-allowed;animation:none}
.tax-confirm-status{color:#888;font-size:.8rem;margin-top:8px}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}

/* Bribe Modal */
.bribe-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:88;flex-direction:column;align-items:center;justify-content:center}
.bribe-modal.active{display:flex}
.bribe-modal-content{background:#16213e;border-radius:16px;padding:24px;max-width:360px;width:90%;text-align:center}
.bribe-modal-content h3{color:#e94560;margin-bottom:12px}
.bribe-target-list{display:flex;flex-direction:column;gap:8px;margin:12px 0}
.bribe-target-btn{background:#0f3460;color:#fff;padding:10px;border-radius:10px;font-size:.9rem;cursor:pointer;border:none}
.bribe-target-btn:hover{background:#e94560}

/* Loan Modal */
.loan-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:88;flex-direction:column;align-items:center;justify-content:center}
.loan-modal.active{display:flex}
.loan-modal-content{background:#16213e;border-radius:16px;padding:24px;max-width:360px;width:90%;text-align:center}
.loan-modal-content h3{color:#2e7d32;margin-bottom:12px}
.loan-modal-content input{width:80px;margin:10px;text-align:center}
.loan-modal-content .loan-warning{color:#e94560;font-size:.8rem;margin:8px 0}

/* Mode selector in lobby */
.mode-selector{display:flex;gap:10px;margin:8px 0}
.mode-btn{flex:1;padding:14px 10px;border-radius:12px;text-align:center;cursor:pointer;border:3px solid transparent;transition:all .2s;background:#0f3460;color:#fff}
.mode-btn.selected{border-color:#e94560;background:#1a1a3e}
.mode-btn .mode-icon{font-size:1.5rem;display:block;margin-bottom:4px}
.mode-btn .mode-name{font-weight:700;font-size:.9rem}
.mode-btn .mode-desc{font-size:.65rem;color:#888;margin-top:2px}

/* Manual tabs */
.manual-tabs{display:flex;gap:8px;margin-bottom:16px}
.manual-tab{padding:8px 20px;border-radius:8px;cursor:pointer;background:#0f3460;color:#fff;font-weight:600;border:2px solid transparent;transition:all .2s}
.manual-tab.active{border-color:#e94560;background:#1a1a3e}
.manual-tab-content{display:none}
.manual-tab-content.active{display:block}

/* ‚îÄ‚îÄ Income Phase: Flying Coin Animation ‚îÄ‚îÄ */
.flying-coin{position:fixed;font-size:1.5rem;z-index:95;pointer-events:none;opacity:1;transition:none}
@keyframes coinFly{0%{opacity:1;transform:scale(1)}80%{opacity:1;transform:scale(.8)}100%{opacity:0;transform:scale(.5)}}

/* King's Allowance Overlay */
.allowance-overlay{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);background:rgba(15,52,96,.92);border:2px solid #e94560;border-radius:16px;padding:16px 36px;z-index:92;text-align:center;pointer-events:none;opacity:0;transition:all .3s ease}
.allowance-overlay.show{transform:translate(-50%,-50%) scale(1);opacity:1}
.allowance-overlay .allowance-text{font-size:1.3rem;font-weight:800;color:#e94560;text-shadow:0 0 10px rgba(233,69,96,.6)}
.allowance-overlay .allowance-icon{font-size:2rem;margin-bottom:4px}

/* Balance Pop Effect */
@keyframes balancePop{0%{transform:scale(1);color:#e0e0e0}30%{transform:scale(1.6);color:#4caf50}60%{transform:scale(1.1);color:#4caf50}100%{transform:scale(1);color:#e0e0e0}}
.balance-pop{animation:balancePop .6s ease}
.balance-flash{position:absolute;top:-14px;right:-10px;color:#4caf50;font-size:.7rem;font-weight:800;opacity:0;animation:flashUp .8s ease forwards;pointer-events:none}
@keyframes flashUp{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-16px)}}

/* Tax Reverse Coin (flies from player to vault) */
.tax-coin{position:fixed;font-size:1.2rem;z-index:95;pointer-events:none;opacity:1}

/* Mobile */
@media(max-width:600px){
  #gameBoard{padding:8px}
  .board-top{margin-bottom:4px}
  .ranking-area{padding:6px 8px;gap:4px;margin-bottom:6px}
  .ranking-area h4{font-size:.65rem;margin-right:4px}
  .ranking-row{font-size:.65rem;padding:2px 6px}
  .ranking-row .rank-medal{font-size:.75rem}
  .roundtable{min-height:300px;margin-bottom:6px;padding:30px 0}
  .roundtable-center{width:90px;height:90px}
  .roundtable-center .deed-card{width:50px;height:70px}
  .roundtable-center .deed-card .value{font-size:1.2rem}
  .player-card{min-width:72px;padding:5px 6px}
  .player-card .pname{max-width:60px;font-size:.65rem}
  .player-card .avatar{font-size:1rem;margin-bottom:0}
  .player-card .stat{font-size:.55rem}
  .player-card .you-badge{font-size:.5rem;padding:1px 4px;top:-6px;right:-6px}
  .high-bid-bar{padding:6px 12px;font-size:.85rem;margin-bottom:6px}
  .high-bid-bar .amount{font-size:.95rem}
  .bid-console{padding:10px 14px;gap:8px}
  .bid-console .prompt{font-size:.85rem}
  .bid-buttons button{min-width:44px;padding:8px 10px;font-size:.85rem}
  .btn-pass{padding:10px 22px;font-size:.95rem}
  .kings-vault{padding:8px 12px;gap:6px}
  .kings-vault .vault-icon{font-size:1.3rem}
  .kings-vault .vault-amount{font-size:1rem}
  .rage-panel{padding:8px 10px;gap:6px}
  .mode-selector{flex-direction:column;gap:6px}
  .mode-btn{padding:10px 8px}
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê LOBBY ‚ïê‚ïê‚ïê‚ïê -->
<div id="lobby" class="screen active">
  <h1>üßà Lootanant</h1>
  <p class="subtitle">Loot the King ‚Äî become his Lieutenant!</p>
  <div class="lobby-box">
    <label>Your Display Name</label>
    <input id="nameInput" placeholder="Enter your name‚Ä¶" maxlength="16" value="">
    <label>Game Mode</label>
    <div class="mode-selector">
      <div class="mode-btn selected" id="modeClassic" onclick="selectMode('classic')">
        <span class="mode-icon">üßà</span>
        <span class="mode-name">Classic</span>
        <span class="mode-desc">The original auction game</span>
      </div>
      <div class="mode-btn" id="modeRage" onclick="selectMode('rage')">
        <span class="mode-icon">üëë</span>
        <span class="mode-name">Rage</span>
        <span class="mode-desc">Taxes, bribes & the King's Vault</span>
      </div>
    </div>
    <button class="btn-primary" onclick="createRoom()">Create Room</button>
    <div class="or-divider">‚Äî or join an existing room ‚Äî</div>
    <label>Room Code</label>
    <input id="joinCodeInput" placeholder="e.g. AB3XY" maxlength="5" style="text-transform:uppercase">
    <button class="btn-secondary" onclick="joinRoom()">Join Room</button>
    <button class="btn-secondary" onclick="showSpectateList()">Spectate Room</button>
    <div style="margin-top:8px;text-align:center">
      <span class="back-link" onclick="showManual()">üìñ How to Play</span>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê SPECTATE LIST ‚ïê‚ïê‚ïê‚ïê -->
<div id="spectateListScreen" class="screen">
  <h2>üì∫ Available Rooms</h2>
  <div id="spectateList"></div>
  <div class="back-link" onclick="showLobby()" style="margin-top:20px">‚Üê Back to Lobby</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê WAITING ROOM ‚ïê‚ïê‚ïê‚ïê -->
<div id="waitingRoom" class="screen">
  <h2>üè† Waiting Room</h2>
  <div class="room-code-display" id="roomCodeDisplay">-----</div>
  <p style="color:#888;font-size:.85rem;margin-bottom:6px">Share this code with friends!</p>
  <ul class="player-list-wait" id="waitPlayerList"></ul>
  <div class="host-controls" id="hostControls" style="display:none">
    <button class="btn-secondary btn-small" onclick="addCpu()">+ Add CPU</button>
    <button class="btn-primary" onclick="startGame()">Start Game</button>
    <button class="btn-secondary btn-small" onclick="discardRoom()" style="background:#e94560">‚Üê Back to Lobby</button>
  </div>
  <div class="game-settings" id="gameSettings" style="display:none">
    <h3>‚öôÔ∏è Game Settings</h3>
    <div class="setting-row">
      <label>üèÜ Win Net Worth</label>
      <input type="number" id="settingWinNW" value="50" min="10" max="200" step="5">
    </div>
    <div class="setting-hint">Points needed to win (10‚Äì200)</div>
    <div class="setting-row">
      <label>¬¢ Starting Money</label>
      <input type="number" id="settingAntCents" value="12" min="1" max="100" step="1">
    </div>
    <div class="setting-hint">Each player starts with this many ¬¢ (1‚Äì100)</div>
  </div>
  <p id="waitMsg" style="color:#888;margin-top:14px;font-size:.9rem"></p>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê GAME BOARD ‚ïê‚ïê‚ïê‚ïê -->
<div id="gameBoard" class="screen">
  <div class="board-top">
    <span class="room-badge" id="boardRoomCode"></span>
    <span id="turnIndicator" style="color:#e94560;font-weight:600"></span>
    <button class="btn-secondary btn-small" id="leaveBtn" onclick="leaveGame()">üö™ Leave</button>
  </div>

  <!-- Ranking Area -->
  <div class="ranking-area" id="rankingArea"></div>

  <!-- King's Vault (Rage mode only) -->
  <div class="kings-vault" id="kingsVault" style="display:none">
    <span class="vault-icon">üëëüè¶</span>
    <div>
      <div class="vault-amount" id="vaultAmount">0 ¬¢</div>
      <div class="vault-label">King's Vault</div>
    </div>
    <div class="tax-countdown" id="taxCountdown"></div>
  </div>

  <!-- Roundtable -->
  <div class="roundtable" id="roundtable">
    <div class="roundtable-center">
      <div class="deed-card" id="deedCard">
        <div class="value" id="deedValue">?</div>
      </div>
    </div>
  </div>

  <!-- High Bid -->
  <div class="high-bid-bar">
    <span>Highest Bid: <span class="amount" id="highBidAmount">0</span> ¬¢</span>
    <span id="highBidder" style="color:#aaa">‚Äî</span>
  </div>

  <!-- Bid Console -->
  <div class="bid-console" id="bidConsole" style="display:none">
    <div class="prompt" id="bidPrompt">Your turn! Place a bid or pass.</div>
    <div class="bid-buttons" id="bidButtons"></div>
    <button class="btn-pass" onclick="doPass()">‚úã Pass</button>
    <div class="timer-bar"><div class="fill" id="timerFill" style="width:100%"></div></div>
  </div>

  <!-- Rage Panel (Rage mode only) -->
  <div class="rage-panel" id="ragePanel" style="display:none">
    <div class="rage-title">üëë Rage Actions</div>
    <button class="btn-bribe" onclick="openBribeModal()">üó°Ô∏è Bribe (1-4¬¢)</button>
    <button class="btn-loan" id="loanBtn" onclick="openLoanModal()">üè¶ Take a Loan</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê TAX OVERLAY ‚ïê‚ïê‚ïê‚ïê -->
<div class="tax-overlay" id="taxOverlay">
  <div class="auditor" id="taxAuditor">üêúüëë</div>
  <h2>The King's Auditor Collects!</h2>
  <div id="taxDetails"></div>
  <button class="tax-confirm-btn" id="taxConfirmBtn" onclick="confirmTaxRead()">Continue</button>
  <div class="tax-confirm-status" id="taxConfirmStatus"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê BRIBE MODAL ‚ïê‚ïê‚ïê‚ïê -->
<div class="bribe-modal" id="bribeModal">
  <div class="bribe-modal-content">
    <h3>üó°Ô∏è Anonymous Bribe</h3>
    <p style="color:#aaa;font-size:.85rem">Pay 1-4¬¢ to increase a player's tax (+10% per ¬¢)<br>Max 40% bribe tax per player. Nobody will know it was you!</p>
    <div class="bribe-target-list" id="bribeTargetList"></div>
    <div class="bribe-amount-step" id="bribeAmountStep" style="display:none">
      <label>Select bribe amount for <b id="bribeTargetName"></b>:</label>
      <div class="bribe-amount-btns" id="bribeAmountBtns"></div>
      <p style="color:#888;font-size:.75rem" id="bribeCapInfo"></p>
    </div>
    <button class="btn-secondary btn-small" onclick="closeBribeModal()" style="margin-top:10px">Cancel</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê LOAN MODAL ‚ïê‚ïê‚ïê‚ïê -->
<div class="loan-modal" id="loanModal">
  <div class="loan-modal-content">
    <h3>üè¶ Take a Loan</h3>
    <p style="color:#ccc;font-size:.95rem;margin:12px 0;line-height:1.5">The King offers <b style="color:#ffd700">5¬¢</b>, but he will take <b style="color:#e94560">35%</b> of your net worth.<br>Do you accept the shame?</p>
    <p style="color:#888;font-size:.75rem;margin-top:4px">Vault has: <b id="loanVaultDisplay">0</b> ¬¢</p>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:14px">
      <button class="btn-loan" onclick="doLoan()">‚úÖ Confirm</button>
      <button class="btn-secondary btn-small" onclick="closeLoanModal()">‚ùå Deny</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê WINNER OVERLAY ‚ïê‚ïê‚ïê‚ïê -->
<div id="winnerOverlay">
  <div class="trophy">üèÜ</div>
  <h2 id="winnerTitle">???</h2>
  <p>has been crowned <b style="color:#e94560">The Lootanant!</b></p>
  <button class="btn-primary" onclick="clearSession();location.reload()">Back to Lobby</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê ROUND BANNER ‚ïê‚ïê‚ïê‚ïê -->
<div class="round-banner" id="roundBanner">
  <h2 id="roundBannerTitle">New Round!</h2>
  <p id="roundBannerText">A new deed has appeared‚Ä¶</p>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê TURN BANNER ‚ïê‚ïê‚ïê‚ïê -->
<div class="turn-banner" id="turnBanner"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê MANUAL ‚ïê‚ïê‚ïê‚ïê -->
<div id="manual" class="screen">
  <div class="manual-box">
    <h2>üìñ How to Loot a King</h2>
    <div class="manual-tabs">
      <div class="manual-tab active" onclick="switchManualTab('classic')">üßà Classic</div>
      <div class="manual-tab" onclick="switchManualTab('rage')">üëë Rage</div>
    </div>

    <!-- Classic Tab -->
    <div class="manual-tab-content active" id="manualClassic">
      <h3>üëë The Lore</h3>
      <p>The King is hoarding the world's purest Gold Bars. As a budding thief, your goal is to prove you have the strategic mind to become his Lieutenant ‚Äî the <b>Lootanant</b>.</p>
      <h3>üìú The Rules</h3>
      <ul>
        <li><span class="icon">üí∞</span><b>Starting Out:</b> You begin with <b>12 ¬¢</b> and <b>0 Net Worth</b>.</li>
        <li><span class="icon">üßà</span><b>The Gold Bar:</b> Every round, a bar appears with a purity (1k‚Äì24k). This is how many points you get for winning it.</li>
        <li><span class="icon">üî®</span><b>The Bidding:</b>
          <ul>
            <li>You must bid <b>higher</b> than the last person.</li>
            <li>You can see how many points (Gold Bars) others have, but you <b>cannot</b> see their money.</li>
            <li>Are they bidding 5 ¬¢ because they're rich, or because it's their last 5 ¬¢? <b>Bluffing is key.</b></li>
          </ul>
        </li>
        <li><span class="icon">‚úÖ</span><b>Winning the Round:</b> If everyone else "Passes," you pay the money and take the bar.</li>
        <li><span class="icon">¬¢</span><b>The Payday:</b> Every time a bar is sold (or discarded), the King drops <b>1 ¬¢</b> for every player.</li>
        <li><span class="icon">üèÜ</span><b>Victory:</b> The moment you hit the target <b>Net Worth</b> (default 50), you win and become the <b>Lootanant!</b></li>
      </ul>
      <h3>üí° Tips</h3>
      <ul>
        <li>Don't blow all your money early ‚Äî you need cents to bid later!</li>
        <li>Watch opponents' Net Worth. If someone is close to 50, you may want to outbid them.</li>
        <li>Sometimes passing is the smartest move. Let others waste their money!</li>
      </ul>
    </div>

    <!-- Rage Tab -->
    <div class="manual-tab-content" id="manualRage">
      <h3>üëë Rage Mode ‚Äî The King Fights Back!</h3>
      <p>Rage mode includes everything from Classic, <b>plus</b> the King's Vault, taxation, anonymous bribing, and desperate loans. The stakes are higher and the betrayals are real!</p>

      <h3>üè¶ The King's Vault & Taxation</h3>
      <ul>
        <li><span class="icon">üìÖ</span><b>Every 5 Rounds:</b> A <b>Taxation Phase</b> triggers after the auction.</li>
        <li><span class="icon">üí∏</span><b>Base Tax:</b> Every player is taxed <b>25%</b> of their total Ant-cents (rounded down).</li>
        <li><span class="icon">üè¶</span><b>The Vault:</b> All taxed cents go into the <b>King's Vault</b> ‚Äî a golden chest displayed prominently on screen.</li>
      </ul>

      <h3>üó°Ô∏è Anonymous Bribing (The Sabotage)</h3>
      <ul>
        <li><span class="icon">üí∞</span><b>Cost:</b> Pay <b>1 ¬¢</b> to increase a target player's tax by <b>+10%</b> for the next Taxation Phase.</li>
        <li><span class="icon">ü§´</span><b>Anonymous:</b> The game announces <i>"Someone whispered to the King‚Ä¶"</i> but <b>never</b> reveals who paid.</li>
        <li><span class="icon">üìä</span><b>Stacking:</b> Bribes stack up to a max of <b>40%</b> extra tax (total max: <b>65%</b>).</li>
        <li><span class="icon">‚ö†Ô∏è</span><b>Indicator:</b> A ‚ö†Ô∏è icon appears next to bribed players so everyone knows who's targeted.</li>
        <li>Bribe money goes directly into the King's Vault.</li>
      </ul>

      <h3>üè¶ Take a Loan (The Recovery)</h3>
      <ul>
        <li><span class="icon">üìâ</span><b>Eligibility:</b> Only players with <b>fewer than 3 ¬¢</b> can take a loan.</li>
        <li><span class="icon">üíµ</span><b>The Offer:</b> The King offers <b>5 ¬¢</b> (deducted from the Vault).</li>
        <li><span class="icon">‚ö†Ô∏è</span><b>Penalty:</b> Lose <b>35%</b> of your Net Worth (rounded to nearest whole number, minimum 3 Karats).</li>
        <li><span class="icon">üì¢</span><b>Public:</b> Everyone sees a notification: <i>"[Player] took a desperate loan!"</i></li>
      </ul>

      <h3>üé∞ Vault Jackpot (The Money Returns!)</h3>
      <ul>
        <li><span class="icon">üìÖ</span><b>Every 11th Round:</b> (Round 11, 22, 33‚Ä¶) is a <b>Jackpot Round</b>.</li>
        <li><span class="icon">üîë</span><b>Key to the Vault:</b> The gold bar becomes the "Key to the Vault" ‚Äî the card glows orange!</li>
        <li><span class="icon">üí∞</span><b>Winner Takes All:</b> Whoever wins the auction gets the gold bar's Karats <b>PLUS up to 20 Ant-cents</b> from the King's Vault.</li>
        <li><span class="icon">üîÑ</span><b>Vault Payout:</b> The jackpot winner receives up to <b>20 ¬¢</b> from the vault. Any remaining cents stay in the vault.</li>
        <li><span class="icon">‚ö†Ô∏è</span><b>No Winner?</b> If nobody bids, the vault keeps its money until the next Jackpot Round.</li>
      </ul>

      <h3>üí° Rage Tips</h3>
      <ul>
        <li>Bribe the leader before a tax round to drain their funds!</li>
        <li>Keep an eye on the vault ‚Äî a big vault means big loan opportunities.</li>
        <li>Taking a loan is risky ‚Äî your net worth drops, putting you further from victory.</li>
        <li>Watch the ‚ö†Ô∏è icons ‚Äî if you're being targeted, save your cents!</li>
        <li>Save your cents for Jackpot Rounds ‚Äî winning one can be a massive game-changer!</li>
      </ul>
    </div>

    <div class="back-link" onclick="showLobby()">‚Üê Back to Lobby</div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- SockJS + STOMP -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let roomCode='', playerId='', hostId='', stompClient=null, timerInterval=null;
let prevState=null, roundNum=0, prevTurnPlayerId=null, renameTimeout=null;
let isSpectator = false;
let selectedGameMode = 'classic';
let currentGameMode = 'classic';
let prevVaultAmount = 0;

// ‚îÄ‚îÄ Mode Selection ‚îÄ‚îÄ
function selectMode(mode){
  selectedGameMode=mode;
  document.getElementById('modeClassic').classList.toggle('selected',mode==='classic');
  document.getElementById('modeRage').classList.toggle('selected',mode==='rage');
}

// ‚îÄ‚îÄ Manual Tabs ‚îÄ‚îÄ
function switchManualTab(tab){
  document.querySelectorAll('.manual-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.manual-tab-content').forEach(t=>t.classList.remove('active'));
  if(tab==='classic'){
    document.querySelectorAll('.manual-tab')[0].classList.add('active');
    document.getElementById('manualClassic').classList.add('active');
  } else {
    document.querySelectorAll('.manual-tab')[1].classList.add('active');
    document.getElementById('manualRage').classList.add('active');
  }
}

// ‚îÄ‚îÄ Persistence ‚îÄ‚îÄ
function saveSession(){
  if(roomCode && playerId) {
    localStorage.setItem('lootanant_session', JSON.stringify({roomCode, playerId, hostId, isSpectator}));
  }
}
function loadSession(){
  const s = localStorage.getItem('lootanant_session');
  return s ? JSON.parse(s) : null;
}
function clearSession(){
  localStorage.removeItem('lootanant_session');
}

window.onload = async () => {
  const s = loadSession();
  if(s) {
    // Try to reconnect
    const res = await fetch('/api/reconnect', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({roomCode: s.roomCode, playerId: s.playerId})
    });
    if(res.ok) {
      roomCode = s.roomCode; playerId = s.playerId; hostId = s.hostId; isSpectator = s.isSpectator;
      connectWS();
    } else {
      clearSession();
    }
  }
};

// ‚îÄ‚îÄ Screen helpers ‚îÄ‚îÄ
function show(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active')}
function showManual(){show('manual')}
function showLobby(){show('lobby')}
function toast(msg,dur){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),dur||6000);
}

function showRoundBanner(title,text,extra,duration){
  const b=document.getElementById('roundBanner');
  document.getElementById('roundBannerTitle').textContent=title;
  document.getElementById('roundBannerText').textContent=text;
  // Add round number if available
  let existingRN=b.querySelector('.round-number');
  if(extra){
    if(!existingRN){existingRN=document.createElement('div');existingRN.className='round-number';b.appendChild(existingRN);}
    existingRN.textContent=extra;
  } else if(existingRN){existingRN.remove();}
  b.classList.add('show');
  setTimeout(()=>b.classList.remove('show'),duration||5000);
}

function showTurnBanner(msg){
  const b=document.getElementById('turnBanner');
  b.textContent=msg;b.classList.add('show');
  setTimeout(()=>b.classList.remove('show'),3500);
}

// ‚îÄ‚îÄ API helpers ‚îÄ‚îÄ
async function api(path,body){const r=await fetch('/api'+path,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});return r.json()}

// ‚îÄ‚îÄ Create Room ‚îÄ‚îÄ
async function createRoom(){
  const name=document.getElementById('nameInput').value.trim()||'Host';
  const data=await api('/create',{name,gameMode:selectedGameMode});
  roomCode=data.roomCode;playerId=data.playerId;hostId=data.hostId;isSpectator=false;
  currentGameMode=data.gameMode||'classic';
  saveSession();
  document.getElementById('roomCodeDisplay').textContent=roomCode;
  document.getElementById('hostControls').style.display='flex';
  document.getElementById('gameSettings').style.display='flex';
  document.getElementById('waitMsg').textContent='Waiting for players‚Ä¶ (min 2 to start)';
  show('waitingRoom');
  connectWS();
}

// ‚îÄ‚îÄ Join Room ‚îÄ‚îÄ
async function joinRoom(){
  const name=document.getElementById('nameInput').value.trim()||'Player';
  const code=document.getElementById('joinCodeInput').value.trim().toUpperCase();
  if(!code){toast('Enter a room code!');return}
  const data=await api('/join',{roomCode:code,name});
  if(data.error){toast(data.error);return}
  roomCode=code;playerId=data.playerId;hostId='';isSpectator=false;
  currentGameMode=data.gameMode||'classic';
  saveSession();
  document.getElementById('roomCodeDisplay').textContent=roomCode;
  document.getElementById('hostControls').style.display='none';
  document.getElementById('gameSettings').style.display='none';
  document.getElementById('waitMsg').textContent='Waiting for host to start‚Ä¶';
  show('waitingRoom');
  connectWS();
}

// ‚îÄ‚îÄ Add / Remove CPU ‚îÄ‚îÄ
async function addCpu(){await api('/addCpu',{roomCode,hostId})}
async function removeCpu(cpuId){await api('/removeCpu',{roomCode,hostId,cpuId})}

// ‚îÄ‚îÄ Start Game ‚îÄ‚îÄ
async function startGame(){
  // Save settings before starting
  const winNW=parseInt(document.getElementById('settingWinNW').value)||50;
  const cents=parseInt(document.getElementById('settingAntCents').value)||12;
  const s=await api('/settings',{roomCode,hostId,winNetWorth:winNW,startingCents:cents});
  if(s.error){toast(s.error);return}
  const d=await api('/start',{roomCode,hostId});if(d.error)toast(d.error)
}

async function spectateRoom(code){
  const codeToJoin = code || document.getElementById('joinCodeInput').value.trim().toUpperCase();
  if(!codeToJoin){toast('Enter a room code!');return}
  const data=await api('/spectate',{roomCode:codeToJoin});
  if(data.error){toast(data.error);return}
  roomCode=codeToJoin;playerId=data.playerId;hostId='';isSpectator=true;
  saveSession();
  document.getElementById('roomCodeDisplay').textContent=roomCode;
  document.getElementById('hostControls').style.display='none';
  document.getElementById('gameSettings').style.display='none';
  document.getElementById('waitMsg').textContent='Spectating...';
  show('waitingRoom');
  connectWS();
}

async function showSpectateList(){
  const res = await fetch('/api/rooms');
  const rooms = await res.json();
  const list = document.getElementById('spectateList');
  list.innerHTML = '';
  if(rooms.length === 0){
    list.innerHTML = '<p style="text-align:center;color:#888">No active rooms found.</p>';
  } else {
    rooms.forEach(r => {
      const item = document.createElement('div');
      item.className = 'room-item';
      item.innerHTML = `
        <div class="room-info">
          <b>Room: ${r.roomCode}</b>
          <span>Host: ${r.hostName}</span>
        </div>
        <button class="btn-primary btn-small">üì∫ Watch</button>
      `;
      item.onclick = () => spectateRoom(r.roomCode);
      list.appendChild(item);
    });
  }
  show('spectateListScreen');
}

async function leaveGame(){
  if(!confirm('Are you sure you want to leave? Your progress will be lost.')) return;
  await api('/leave', {roomCode, playerId});
  clearSession();
  location.reload();
}
async function discardRoom(){
  if(!confirm('Are you sure? This will close the room for everyone.')) return;
  await api('/discardRoom', {roomCode, hostId});
  clearSession();
  location.reload();
}

// ‚îÄ‚îÄ Rename ‚îÄ‚îÄ
function scheduleRename(newName){
  if(renameTimeout)clearTimeout(renameTimeout);
  renameTimeout=setTimeout(()=>{
    api('/rename',{roomCode,playerId,name:newName});
  },400);
}

// ‚îÄ‚îÄ WebSocket ‚îÄ‚îÄ
function connectWS(){
  const socket=new SockJS('/ws');
  stompClient=Stomp.over(socket);
  stompClient.debug=null;
  stompClient.connect({},()=>{
    // Personal state channel
    stompClient.subscribe('/topic/room/'+roomCode+'/state/'+playerId, msg=>{
      const state=JSON.parse(msg.body);
      if(state.started&&!state.finished) renderGame(state);
      else if(!state.started) renderWaiting(state);
    });
    // Room discarded event
    stompClient.subscribe('/topic/room/'+roomCode+'/roomDiscarded', msg=>{
      toast('Room has been discarded by the host.');
      clearSession();
      location.reload();
    });
    // Game started event (ensures all players transition)
    stompClient.subscribe('/topic/room/'+roomCode+'/gameStarted', msg=>{
      // Force fetch state and switch to game
      fetch('/api/state/'+roomCode+'/'+playerId).then(r=>r.json()).then(state=>{
        if(state.started) renderGame(state);
      });
    });
    // Income phase animation
    stompClient.subscribe('/topic/room/'+roomCode+'/incomePhase', msg=>{
      const data=JSON.parse(msg.body);
      playIncomeAnimation(data);
    });
    // Round results
    stompClient.subscribe('/topic/room/'+roomCode+'/roundResult', msg=>{
      const r=JSON.parse(msg.body);
      if(r.discarded){
        showRoundBanner('Bar Discarded!','No bids this round.','Round '+(roundNum)+' ended');
      } else {
        let winMsg='Paid '+r.bidPaid+' ¬¢ for a '+r.purity+'k purity gold bar.';
        if(r.jackpotRound && r.jackpotAmount){
          winMsg='Paid '+r.bidPaid+' ¬¢ for a '+r.purity+'k bar + üí∞ '+r.jackpotAmount+' ¬¢ JACKPOT from the Vault!';
          toast('üé∞ VAULT JACKPOT! '+r.roundWinner+' wins '+r.jackpotAmount+' ¬¢ from the King\'s Vault! (max 20¬¢)',8000);
        }
        showRoundBanner(r.jackpotRound?'üé∞ JACKPOT! '+r.roundWinner+' Wins!':'üî® '+r.roundWinner+' Wins the Bid!',winMsg,'Round '+(roundNum)+' ended');
      }
    });
    // Rage events (bribe, loan, taxation)
    stompClient.subscribe('/topic/room/'+roomCode+'/rageEvent', msg=>{
      const evt=JSON.parse(msg.body);
      if(evt.type==='bribe'){
        toast('üó°Ô∏è '+evt.message,4000);
      } else if(evt.type==='loan'){
        toast('üè¶ '+evt.message,4000);
        // Shake vault animation
        const vault=document.getElementById('kingsVault');
        vault.classList.add('shake');
        setTimeout(()=>vault.classList.remove('shake'),600);
      } else if(evt.type==='taxation'){
        // Play reverse coin animation (players ‚Üí vault) before showing overlay
        playTaxReverseAnimation(evt.details);
        setTimeout(()=>showTaxOverlay(evt),1200);
      }
    });
    // Winner
    stompClient.subscribe('/topic/room/'+roomCode+'/winner', msg=>{
      const w=JSON.parse(msg.body);
      document.getElementById('winnerTitle').textContent=w.winnerName;
      document.getElementById('winnerOverlay').classList.add('active');
    });
    // Request initial state
    fetch('/api/state/'+roomCode+'/'+playerId).then(r=>r.json()).then(state=>{
      if(state.started) renderGame(state);
      else renderWaiting(state);
    });
  });
}

// ‚îÄ‚îÄ Render Waiting ‚îÄ‚îÄ
function renderWaiting(state){
  // Sync settings display for host
  if(hostId&&state.winNetWorth!=null){
    const nwInput=document.getElementById('settingWinNW');
    const acInput=document.getElementById('settingAntCents');
    if(nwInput&&document.activeElement!==nwInput)nwInput.value=state.winNetWorth;
    if(acInput&&document.activeElement!==acInput)acInput.value=state.startingAntCents;
  }
  const ul=document.getElementById('waitPlayerList');
  // Check if the rename input is currently focused ‚Äî if so, skip re-render to avoid mobile keyboard dismissal
  const activeEl=document.activeElement;
  const renameInputFocused=activeEl&&activeEl.tagName==='INPUT'&&activeEl.closest('.player-list-wait');
  if(renameInputFocused){
    // Only update other players' names without touching the focused input
    const items=ul.querySelectorAll('li');
    let idx=0;
    state.players.forEach(p=>{
      if(idx<items.length){
        if(!p.isYou){
          if(p.cpu) items[idx].textContent='ü§ñ '+p.displayName;
          else items[idx].textContent='üêú '+p.displayName;
        }
      }
      idx++;
    });
    return;
  }
  ul.innerHTML='';
  state.players.forEach(p=>{
    const li=document.createElement('li');
    if(p.cpu){
      li.classList.add('cpu');
      li.textContent='ü§ñ '+p.displayName;
      // Add remove button for host
      if(hostId && !state.started){
        const removeBtn=document.createElement('button');
        removeBtn.textContent='‚ûñ';
        removeBtn.style.cssText='margin-left:8px;background:#e94560;color:#fff;border:none;border-radius:50%;width:22px;height:22px;font-size:.7rem;cursor:pointer;padding:0;line-height:22px';
        removeBtn.onclick=()=>removeCpu(p.id);
        li.appendChild(removeBtn);
      }
    } else if(p.isYou){
      const lbl=document.createElement('span');
      lbl.textContent='‚≠ê ';
      li.appendChild(lbl);
      const inp=document.createElement('input');
      inp.value=p.displayName;
      inp.maxLength=16;
      inp.placeholder='Your name';
      inp.addEventListener('input',()=>scheduleRename(inp.value.trim()||'Player'));
      li.appendChild(inp);
    } else {
      li.textContent='üêú '+p.displayName;
    }
    ul.appendChild(li);
  });
}

// ‚îÄ‚îÄ Seat positions for roundtable ‚îÄ‚îÄ
function getSeatPositions(count){
  // Arrange seats in a circle around center
  const positions=[];
  const isMobile=window.innerWidth<=600;
    const rx=isMobile?44:40, ry=isMobile?44:40; // % from center
  for(let i=0;i<count;i++){
    const angle=(2*Math.PI*i/count)-Math.PI/2; // start from top
    const x=50+rx*Math.cos(angle);
    const y=50+ry*Math.sin(angle);
    positions.push({x,y});
  }
  return positions;
}

// ‚îÄ‚îÄ Render Game ‚îÄ‚îÄ
function renderGame(state){
  show('gameBoard');
  currentGameMode=state.gameMode||'classic';
  document.getElementById('boardRoomCode').textContent='Room: '+state.roomCode+(currentGameMode==='rage'?' üëë':'');
  document.getElementById('highBidAmount').textContent=state.currentHighBid;

  // Rage mode: King's Vault
  const vaultEl=document.getElementById('kingsVault');
  const ragePanelEl=document.getElementById('ragePanel');
  if(currentGameMode==='rage'){
    vaultEl.style.display='flex';
    const vaultAmt=state.kingsVault||0;
    document.getElementById('vaultAmount').textContent=vaultAmt+' ¬¢';
    // Glow effect when vault grows
    if(vaultAmt>prevVaultAmount){
      vaultEl.classList.add('glow');
      setTimeout(()=>vaultEl.classList.remove('glow'),1500);
    }
    prevVaultAmount=vaultAmt;
    // Tax countdown & jackpot info
    const nextTax=state.nextTaxRound||0;
    const nextJackpot=state.nextJackpotRound||0;
    let countdownText;
    if(nextTax===0) countdownText='üí∏ Tax this round!';
    else countdownText='Tax in '+nextTax+' round'+(nextTax!==1?'s':'');
    if(state.isJackpotRound) countdownText='üé∞ JACKPOT ROUND!';
    else if(nextJackpot===0) countdownText+=' | üé∞ Jackpot this round!';
    else countdownText+=' | Jackpot in '+nextJackpot;
    document.getElementById('taxCountdown').textContent=countdownText;
    // Update tax confirmation status if overlay is showing
    updateTaxConfirmStatus(state);
    // Rage panel (only for non-spectators)
    if(!state.isSpectator){
      ragePanelEl.style.display='flex';
      // Loan button: only enabled if player has < 3 cents
      const me=state.players.find(p=>p.id===playerId);
      const loanBtn=document.getElementById('loanBtn');
      if(me&&me.cents<3&&vaultAmt>=5){
        loanBtn.disabled=false;loanBtn.style.opacity='1';
      } else {
        loanBtn.disabled=true;loanBtn.style.opacity='.4';
      }
    } else {
      ragePanelEl.style.display='none';
    }
  } else {
    vaultEl.style.display='none';
    ragePanelEl.style.display='none';
  }

  // Deed card
  const purityEl=document.getElementById('deedValue');
  const goldBarCard=document.getElementById('deedCard');
  if(!prevState||prevState.currentGoldBarPurity!==state.currentGoldBarPurity){
    purityEl.textContent=state.currentGoldBarPurity+'k';
    // Show winning point once at game start
    if(!prevState) toast('üèÜ Target Net Worth: '+state.winNetWorth+' ‚Äî First to reach it wins!',5000);
    goldBarCard.classList.remove('flip-in','jackpot-card');
    void goldBarCard.offsetWidth;
    goldBarCard.classList.add('flip-in');
    if(currentGameMode==='rage'&&state.isJackpotRound) goldBarCard.classList.add('jackpot-card');
    if(prevState&&prevState.currentGoldBarPurity!==state.currentGoldBarPurity){
      roundNum++;
      const isJackpot=currentGameMode==='rage'&&state.isJackpotRound;
      if(isJackpot){
        toast('üé∞ JACKPOT ROUND '+roundNum+'! Winner gets the gold bar + up to 20¬¢ from the Vault!',8000);
        showRoundBanner('üé∞ Jackpot Round!','A '+state.currentGoldBarPurity+'k gold bar ‚Äî Key to the Vault! Winner takes up to 20¬¢ (Vault: '+((state.kingsVault||0))+' ¬¢)!','üì¢ Round '+roundNum+' starts now!', 1000);
      } else {
        toast('üì¢ A new round has started! Round '+roundNum,6000);
        showRoundBanner('üßà New Gold Bar!','üì¢ Round '+roundNum+' starts now!', null, 1000);
      }
    }
  }

  // High bidder name
  const hb=state.players.find(p=>p.id===state.currentHighBidderId);
  document.getElementById('highBidder').textContent=hb?('by '+hb.displayName):'No bids yet';

  // Current turn
  const ct=state.players.find(p=>p.id===state.currentTurnPlayerId);
  const isMyTurn=state.currentTurnPlayerId===playerId;
  document.getElementById('turnIndicator').textContent=ct?(isMyTurn?'üéØ Your Turn!':'‚è≥ '+ct.displayName+"'s turn"):'';

  // Turn change animation
  if(prevState && state.currentTurnPlayerId && state.currentTurnPlayerId !== prevTurnPlayerId){
    if(isMyTurn && !state.isSpectator){
      showTurnBanner('üéØ Your Turn!');
    } else if(ct){
      showTurnBanner('‚è≥ '+ct.displayName+"'s turn");
    }
  }
  prevTurnPlayerId=state.currentTurnPlayerId;

  // Ranking area (top 3)
  const rankArea=document.getElementById('rankingArea');
  const sorted=[...state.players].sort((a,b)=>b.netWorth-a.netWorth);
  const top3=sorted.slice(0,3);
  const medals=['ü•á','ü•à','ü•â'];
  rankArea.innerHTML='<h4>üèÜ Top Ranking</h4>'+top3.map((p,i)=>{
    const bribeMark=(currentGameMode==='rage'&&p.bribed)?'‚ö†Ô∏è ':'';
    return `<div class="ranking-row"><span class="rank-medal">${medals[i]}</span><span class="rank-name">${bribeMark}${p.displayName}${p.id===playerId?' (You)':''}</span><span class="rank-nw">${p.netWorth} üßà</span></div>`;
  }).join('');

  // Roundtable player seats
  const table=document.getElementById('roundtable');
  // Remove old seats
  table.querySelectorAll('.player-seat').forEach(s=>s.remove());
  const seats=getSeatPositions(state.players.length);
  state.players.forEach((p,i)=>{
    const seat=document.createElement('div');
    seat.className='player-seat';
    seat.style.left=seats[i].x+'%';
    seat.style.top=seats[i].y+'%';
    seat.style.transform='translate(-50%,-50%)';

    const card=document.createElement('div');
    card.className='player-card';
    if(p.id===state.currentTurnPlayerId)card.classList.add('active-turn');
    if(p.passed)card.classList.add('passed');
    if(p.id===state.winnerId)card.classList.add('winner-card');

    // Detect net worth increase for animation
    let nwClass='';
    if(prevState){
      const prev=prevState.players.find(pp=>pp.id===p.id);
      if(prev&&p.netWorth>prev.netWorth) nwClass='nw-pop';
    }

    // Detect bid win glow
    let bidWinClass='';
    if(prevState&&prevState.currentHighBidderId!==state.currentHighBidderId&&p.id===state.currentHighBidderId){
      bidWinClass='bid-win-glow';
    }

    const bribeIcon=(currentGameMode==='rage'&&p.bribed)?'<span class="bribe-indicator">‚ö†Ô∏è</span>':'';
    card.innerHTML=`
      ${bribeIcon}
      <div class="avatar">${p.cpu?'ü§ñ':(p.connected?'üêú':'üò¥')}</div>
      ${p.id===playerId?'<span class="you-badge">YOU</span>':''}
      <div class="pname">${p.displayName}</div>
      <div class="stat ${nwClass}">üßà <b>${p.netWorth}</b></div>
      ${p.id===playerId?`<div class="stat">¬¢ ${p.cents}</div>`:''}
      ${p.passed?'<div class="stat" style="color:#e94560">Passed</div>':''}
      ${!p.connected?'<div class="stat" style="color:#888">Disconnected</div>':''}
    `;
    if(bidWinClass)card.classList.add(bidWinClass);

    seat.appendChild(card);
    table.appendChild(seat);
  });

  // Bid console
  const console_=document.getElementById('bidConsole');
  if(isMyTurn && !state.finished && !state.isSpectator){
    console_.style.display='flex';
    console_.classList.remove('fade-scale');
    void console_.offsetWidth;
    console_.classList.add('fade-scale');
    const minBid=state.currentHighBid+1;
    const me=state.players.find(p=>p.id===playerId);
    const myMoney=me?me.cents:0;
    const btns=document.getElementById('bidButtons');
    btns.innerHTML='';
    if(myMoney>=minBid){
      // Show all available bid amounts as buttons
      for(let b=minBid;b<=myMoney;b++){
        const btn=document.createElement('button');
        btn.textContent=b+' ¬¢';
        btn.onclick=()=>doBid(b);
        btns.appendChild(btn);
      }
    }
    document.getElementById('bidPrompt').textContent=myMoney>=minBid?`Bid at least ${minBid} ¬¢ (you have ${myMoney} ¬¢)`:'You cannot outbid ‚Äî pass this round.';
    startTimerBar();
  } else {
    console_.style.display='none';
    stopTimerBar();
  }
  if(state.isSpectator) {
    document.getElementById('turnIndicator').textContent = (state.currentTurnPlayerId && !state.finished) ? 'Watching...' : (state.finished ? 'Game Over' : 'Waiting...');
    const leaveBtn = document.getElementById('leaveBtn');
    if (leaveBtn) leaveBtn.style.display = 'none';
  }

  prevState=JSON.parse(JSON.stringify(state));
}

// ‚îÄ‚îÄ Actions ‚îÄ‚îÄ
async function doBid(amount){
  document.getElementById('bidConsole').style.display='none';
  stopTimerBar();
  await api('/bid',{roomCode,playerId,amount});
}
async function doPass(){
  document.getElementById('bidConsole').style.display='none';
  stopTimerBar();
  await api('/pass',{roomCode,playerId});
}

// ‚îÄ‚îÄ Income Phase Animation ‚îÄ‚îÄ
function playIncomeAnimation(data){
  // 1. Show "KING'S ALLOWANCE" overlay
  let overlay=document.getElementById('allowanceOverlay');
  if(!overlay){
    overlay=document.createElement('div');
    overlay.id='allowanceOverlay';
    overlay.className='allowance-overlay';
    overlay.innerHTML='<div class="allowance-icon">üëëüí∞</div><div class="allowance-text">You Got: +1¬¢</div>';
    document.body.appendChild(overlay);
  }
  void overlay.offsetWidth;
  overlay.classList.add('show');
  setTimeout(()=>overlay.classList.remove('show'),1400);

  // 2. Spawn flying coins toward each player's balance area
  const playerCards=document.querySelectorAll('.player-card');
  const startX=window.innerWidth/2;
  const startY=window.innerHeight/2;
  playerCards.forEach((card,i)=>{
    setTimeout(()=>{
      const coin=document.createElement('div');
      coin.className='flying-coin';
      coin.textContent='ü™ô';
      coin.style.left=startX+'px';
      coin.style.top=startY+'px';
      document.body.appendChild(coin);
      const rect=card.getBoundingClientRect();
      const endX=rect.left+rect.width/2;
      const endY=rect.top+rect.height/2;
      // Bezier curve via CSS transition
      requestAnimationFrame(()=>{
        coin.style.transition='left 0.8s cubic-bezier(.17,.67,.35,1.2), top 0.8s cubic-bezier(.17,.67,.83,.67), opacity 0.8s ease';
        coin.style.left=endX+'px';
        coin.style.top=endY+'px';
        coin.style.opacity='0';
      });
      // 3. Balance pop when coin arrives
      setTimeout(()=>{
        coin.remove();
        // Flash the balance stat green
        const stats=card.querySelectorAll('.stat');
        stats.forEach(s=>{
          if(s.textContent.includes('¬¢')){
            s.classList.remove('balance-pop');
            void s.offsetWidth;
            s.classList.add('balance-pop');
            // Add +1¬¢ flash
            const flash=document.createElement('span');
            flash.className='balance-flash';
            flash.textContent='+1¬¢';
            card.appendChild(flash);
            setTimeout(()=>flash.remove(),900);
          }
        });
      },800);
    },i*120);
  });
}

// ‚îÄ‚îÄ Tax Reverse Animation (coins fly from players to vault) ‚îÄ‚îÄ
function playTaxReverseAnimation(taxDetails){
  const vaultEl=document.getElementById('kingsVault');
  if(!vaultEl||vaultEl.style.display==='none')return;
  const vaultRect=vaultEl.getBoundingClientRect();
  const endX=vaultRect.left+vaultRect.width/2;
  const endY=vaultRect.top+vaultRect.height/2;
  const playerCards=document.querySelectorAll('.player-card');
  playerCards.forEach((card,i)=>{
    const detail=taxDetails&&taxDetails[i];
    if(detail&&detail.taxAmount<=0)return;
    setTimeout(()=>{
      const rect=card.getBoundingClientRect();
      const coin=document.createElement('div');
      coin.className='tax-coin';
      coin.textContent='ü™ô';
      coin.style.left=(rect.left+rect.width/2)+'px';
      coin.style.top=(rect.top+rect.height/2)+'px';
      document.body.appendChild(coin);
      requestAnimationFrame(()=>{
        coin.style.transition='left 1s cubic-bezier(.17,.67,.35,1.2), top 1s cubic-bezier(.17,.67,.83,.67), opacity 1s ease';
        coin.style.left=endX+'px';
        coin.style.top=endY+'px';
        coin.style.opacity='0';
      });
      setTimeout(()=>{
        coin.remove();
        vaultEl.classList.add('glow');
        setTimeout(()=>vaultEl.classList.remove('glow'),800);
      },1000);
    },i*150);
  });
}

// ‚îÄ‚îÄ Timer Bar ‚îÄ‚îÄ
function startTimerBar(){
  stopTimerBar();
  let remaining=20;
  const fill=document.getElementById('timerFill');
  fill.style.width='100%';
  timerInterval=setInterval(()=>{
    remaining-=0.1;
    if(remaining<=0){remaining=0;stopTimerBar()}
    fill.style.width=(remaining/20*100)+'%';
  },100);
}
function stopTimerBar(){if(timerInterval){clearInterval(timerInterval);timerInterval=null}}

// ‚îÄ‚îÄ Rage Mode: Bribe Modal ‚îÄ‚îÄ
let selectedBribeTargetId=null;
function openBribeModal(){
  if(!prevState)return;
  selectedBribeTargetId=null;
  document.getElementById('bribeAmountStep').style.display='none';
  const list=document.getElementById('bribeTargetList');
  list.innerHTML='';
  list.style.display='flex';
  const me=prevState.players.find(p=>p.id===playerId);
  const myMoney=me?me.cents:0;
  prevState.players.forEach(p=>{
    if(p.id===playerId)return;
    const maxMore=(40-(p.bribeTaxPercent||0))/10;
    const btn=document.createElement('button');
    btn.className='bribe-target-btn';
    btn.textContent=(p.cpu?'ü§ñ ':'')+p.displayName+(p.bribed?' ‚ö†Ô∏è '+p.bribeTaxPercent+'%':'');
    if(maxMore<=0){
      btn.disabled=true;btn.style.opacity='.4';
      btn.textContent+=' (MAX)';
    }
    btn.onclick=()=>selectBribeTarget(p.id,p.displayName,maxMore,myMoney,p.bribeTaxPercent||0);
    list.appendChild(btn);
  });
  document.getElementById('bribeModal').classList.add('active');
}
function selectBribeTarget(targetId,targetName,maxMore,myMoney,currentBribe){
  selectedBribeTargetId=targetId;
  document.getElementById('bribeTargetList').style.display='none';
  document.getElementById('bribeAmountStep').style.display='flex';
  document.getElementById('bribeTargetName').textContent=targetName;
  const maxAmount=Math.min(4,maxMore,myMoney);
  document.getElementById('bribeCapInfo').textContent='Current bribe tax: '+currentBribe+'% | Max additional: '+(maxMore*10)+'% | You have: '+myMoney+'¬¢';
  const btnsDiv=document.getElementById('bribeAmountBtns');
  btnsDiv.innerHTML='';
  for(let i=1;i<=4;i++){
    const btn=document.createElement('button');
    btn.textContent=i+'¬¢ (+'+i*10+'%)';
    btn.disabled=i>maxAmount;
    btn.onclick=()=>doBribe(targetId,i);
    btnsDiv.appendChild(btn);
  }
}
function closeBribeModal(){
  document.getElementById('bribeModal').classList.remove('active');
  selectedBribeTargetId=null;
}
async function doBribe(targetId,amount){
  closeBribeModal();
  const res=await api('/bribe',{roomCode,playerId,targetId,amount});
  if(res.error)toast('‚ùå '+res.error);
}

// ‚îÄ‚îÄ Rage Mode: Loan Modal ‚îÄ‚îÄ
function openLoanModal(){
  if(!prevState)return;
  const vault=prevState.kingsVault||0;
  document.getElementById('loanVaultDisplay').textContent=vault;
  document.getElementById('loanModal').classList.add('active');
}
function closeLoanModal(){document.getElementById('loanModal').classList.remove('active')}
async function doLoan(){
  closeLoanModal();
  const res=await api('/loan',{roomCode,playerId});
  if(res.error)toast('‚ùå '+res.error);
  else toast('üè¶ Loan taken! +5¬¢ but lost '+res.penalty+' Karats.',5000);
}

// ‚îÄ‚îÄ Rage Mode: Tax Overlay ‚îÄ‚îÄ
let taxConfirmed=false;
function showTaxOverlay(evt){
  taxConfirmed=false;
  const overlay=document.getElementById('taxOverlay');
  const details=document.getElementById('taxDetails');
  const confirmBtn=document.getElementById('taxConfirmBtn');
  const confirmStatus=document.getElementById('taxConfirmStatus');
  confirmBtn.disabled=false;
  confirmBtn.textContent='Continue';
  confirmStatus.textContent='';
  let html='<p style="color:#ffd700;font-size:1rem;margin:8px 0">Total collected: <b>'+evt.totalCollected+' ¬¢</b> ‚Üí Vault: <b>'+evt.vaultTotal+' ¬¢</b></p>';
  (evt.details||[]).forEach(d=>{
    const bribeTag=d.hadBribe?' <span style="color:#e94560">(+bribe!)</span>':'';
    html+='<p class="tax-detail">'+d.playerName+': -'+d.taxAmount+' ¬¢ ('+d.taxPercent+'% tax)'+bribeTag+'</p>';
  });
  details.innerHTML=html;
  overlay.classList.add('active');
  // Reset auditor animation
  const auditor=document.getElementById('taxAuditor');
  auditor.style.animation='none';
  void auditor.offsetWidth;
  auditor.style.animation='auditorWalk 3s ease-in-out';
  // Overlay stays until player confirms (or auto-dismissed when state says no longer waiting)
}
async function confirmTaxRead(){
  if(taxConfirmed)return;
  taxConfirmed=true;
  const btn=document.getElementById('taxConfirmBtn');
  btn.disabled=true;
  btn.textContent='‚úÖ Confirmed ‚Äî Waiting for others...';
  await api('/confirmTax',{roomCode,playerId});
}
function updateTaxConfirmStatus(state){
  if(!state.waitingForTaxConfirmation){
    // Tax phase done, close overlay
    document.getElementById('taxOverlay').classList.remove('active');
    return;
  }
  const status=document.getElementById('taxConfirmStatus');
  if(status) status.textContent=(state.taxConfirmedCount||0)+'/'+( state.taxTotalPlayers||0)+' players confirmed';
}
</script>
</body>
</html>
